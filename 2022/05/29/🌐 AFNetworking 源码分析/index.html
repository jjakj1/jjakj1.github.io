<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> ğŸŒ AFNetworking æºç åˆ†æ Â· jjakj1's blog</title><meta name="description" content="ğŸŒ AFNetworking æºç åˆ†æ - Shanyu Li"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="../../../../maze.png"><link rel="stylesheet" href="../../../../css/hermes.css"><link rel="search" type="application/opensearchdescription+xml" href="http://example.com/atom.xml" title="jjakj1's blog"><meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="atom.xml" title="jjakj1's blog" type="application/atom+xml">
</head><body><div class="wrap"><header><a class="logo-link" href="../../../../index.html"><img src="../../../../videogame.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="../../../../index.html" target="_self">BLOG</a></li><li class="nav-list-item"><a class="nav-list-link" href="https://github.com/jjakj1" target="_blank">GITHUB</a></li><li class="nav-list-item"><a class="nav-list-link" href="../../../../archives/" target="_self">ARCHIVE</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">ğŸŒ AFNetworking æºç åˆ†æ</h1><div class="post-info">May 29, 2022</div><div class="post-content"><p>ç ”ç©¶äº† AFNetworking ç½‘ç»œæ¡†æ¶çš„ä¸»è¦ç»“æ„å’Œæ–¹æ³•ï¼Œå¯¹å…¶å†…éƒ¨å¦‚ä½•å»ºç«‹ä¸€ä¸ªè¯·æ±‚ï¼Œåšäº†å“ªäº›é¢å¤–å·¥ä½œï¼Œç‰¹åˆ«æ˜¯å¦‚ä½•å‘é€ä¸€ä¸ª multipart request è¯·æ±‚è¿›è¡Œäº†è¾ƒä¸ºæ·±å…¥çš„åˆ†æã€‚</p>
<span id="more"></span>

<p>AFNetworking ä½œä¸º iOS æœ€è‘—åçš„ç½‘ç»œæ¡†æ¶ä¹‹ä¸€ï¼Œå¯¹å®˜æ–¹ <code>NSURLSession</code> ä¸€ç³»åˆ— API è¿›è¡Œäº†å°è£…ï¼Œæä¾›äº†å¤§é‡æ›´æ–¹ä¾¿ä½¿ç”¨çš„æ¥å£ã€‚</p>
<p>å¯¹äºè¿™æ ·ä¸€ç§æ¡†æ¶ï¼Œæˆ‘è®¤ä¸ºæƒ³è¦äº†è§£å…¶ç›¸å¯¹äºåŸç”Ÿ API çš„ä¼˜åŠ¿ï¼Œé¦–å…ˆå°±éœ€è¦å¯¹ä¸¤è€… API çš„ä½¿ç”¨æœ‰ä¸€å®šçš„äº†è§£ï¼Œåœ¨é˜…è¯»å…¶æºç å‰ï¼Œæˆ‘å†™äº†ä¸€ä¸ª Demoã€‚Demo ä½¿ç”¨çš„ç½‘ç»œè¯·æ±‚ç±»ä¸­åŒæ—¶æä¾›æ¥å£ç›¸åŒçš„ã€ä½†å†…éƒ¨åˆ†åˆ«ç”±åŸç”Ÿ API å’Œ AFNetworking API å®ç°ï¼Œä»¥æ­¤æ¥æ„Ÿå—åŒæ–¹ API çš„å·®å¼‚æ€§ã€‚è¯¦æƒ…å¯ä»¥å‚è€ƒ <a target="_blank" rel="noopener" href="https://github.com/jjakj1/AFNetworkingDemo">Github</a> ä¸­çš„ <code>NetworkingDataManager</code> ç±»ã€‚ï¼ˆå…¶å®æœ€å¼€å§‹è¿›è¡Œå¯¹æ¯”çš„æ—¶å€™ï¼Œæˆ‘æ²¡æœ‰ç‰¹åˆ«æ„Ÿå—åˆ° AFNetworking ç›¸å¯¹äºåŸç”Ÿ API æ–¹ä¾¿å¾ˆå¤šï¼Œå¯èƒ½æ›´å¤šç»†èŠ‚åœ¨äºå¯¹äºé”™è¯¯æƒ…å†µçš„å¤„ç†å’Œæ•°æ®çš„è½¬æ¢ä¸Šï¼Œè¿™ä¸ªéœ€è¦ç­‰é˜…è¯»æºç åæ‰èƒ½å¾—å‡ºç»“è®ºï¼‰</p>
<h2 id="AFURLSessionManager"><a href="#AFURLSessionManager" class="headerlink" title="AFURLSessionManager"></a>AFURLSessionManager</h2><p><code>AFURLSessionManger</code> ä½œä¸ºè°ƒç”¨ AFNetworking æ‰€æä¾›çš„ API çš„ç±»ï¼Œå¤§è‡´ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="https://res.craft.do/user/full/ea081854-0d6c-dace-b07b-5007ad758cc9/doc/BAA570CA-8DD7-4D68-9E22-C44B50358FF0/BE908F8C-99D6-49B7-A074-E0B057FB241D_2/VaA0yRAbWDxG6ohe6papFFzxtYxxrh4ZyFVBBg71ynQz/AFURLSessionManager.png" alt="AFURLSessionManager.png"></p>
<p>å…¶ä¸­ <code>AFURLSessionManager</code> è‡ªèº«å®ç°äº†å‡ ä¸ªå®˜æ–¹çš„ Delegateï¼Œå¹¶æä¾›äº†ä¸€ç³»åˆ—çš„ block ä½œä¸ºå±æ€§ï¼Œè®©å¤–ç•Œå»è®¾ç½®ã€‚å†…éƒ¨ç§æœ‰äº†ä¸€ä¸ª <code>AFURLSessionManagerTaskDelegate</code> ç±»ï¼Œå…¶å®ç°äº†é™¤ <code>NSURLSessionDelegate</code> ä¹‹å¤–å…¶ä»–ä¸‰ä¸ª Delegate çš„å¤§éƒ¨åˆ†æ–¹æ³•ã€‚</p>
<p><code>AFURLSessionManager</code> å†…éƒ¨æœ€é‡è¦çš„ç»“æ„æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œå…¶ä½¿ç”¨åˆ›å»ºçš„å„ä¸ª <code>URLSessionTask</code> çš„ identifier ä½œä¸ºé”®ï¼Œå¹¶å°†ä¸€ä¸ª <code>AFURLSessionManagerTaskDelegate</code> å¯¹è±¡ä½œä¸ºå€¼ï¼Œè¯¥å¯¹è±¡ä¼šåœ¨æ¯æ¬¡åˆ›å»ºä¸€ä¸ªæ–°çš„ task æ—¶è¢«åŒæ—¶åˆ›å»ºï¼Œå¹¶å°†ä¸€äº›ä¸ºäº†å®ç°ä¸‰ç§ä»£ç†ä¸­æ–¹æ³•æ‰€éœ€è¦çš„ block ä¼ å…¥è¿›å»ã€‚Delegate æœ€ç»ˆä¼šåœ¨ <code>URLSession:task:didCompleteWithError:</code> ä¸­è¢«é‡Šæ”¾</p>
<p><code>AFURLSessionManager</code> å¤„ç†ä¸€ä¸ªä»£ç†æ–¹æ³•æœ€æ™®éçš„è¡Œä¸ºå®é™…ä¸Šåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š</p>
<ul>
<li><code>AFURLSessionManagerTaskDelegate</code> å¦‚æœä¹Ÿå®ç°äº†é‚£ä¸ªä»£ç†æ–¹æ³•ï¼Œå°±ä¼šä»å­—å…¸é‡Œæ‰¾åˆ°å½“å‰ task å¯¹åº”çš„ Delegate å¹¶è°ƒç”¨ Delegate é‡Œé¢çš„å¯¹åº”ä»£ç†æ–¹æ³•ã€‚</li>
<li>å¦‚æœ <code>AFURLSessionManagerTaskDelegate</code> æ²¡æœ‰å®ç°è¯¥æ–¹æ³•ï¼Œå°±åˆ¤æ–­å¯¹åº”çš„ block æ˜¯å¦è¢«è®¾ç½®ï¼Œå¦‚æœè¿›è¡Œäº†è®¾ç½®ï¼Œåˆ™è°ƒç”¨è¯¥ blockã€‚</li>
</ul>
<p>å¦å¤–å†…éƒ¨è¿˜ä¿å­˜å¹¶é»˜è®¤è®¾ç½®äº†ä»¥ä¸‹å±æ€§æ¥å¯¹å†…éƒ¨çš„çŠ¶æ€å’Œæ•°æ®è¿›è¡Œå¤„ç†ï¼Œåç»­ä¹Ÿä¼šè¿›è¡Œåˆ†æã€‚</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="type">id</span> &lt;AFURLResponseSerialization&gt; responseSerializer; <span class="comment">// default is AFJSONResponseSerializer</span></span><br></pre></td></tr></table></figure>

<h2 id="AFHTTPSessionManager"><a href="#AFHTTPSessionManager" class="headerlink" title="AFHTTPSessionManager"></a>AFHTTPSessionManager</h2><p>ç»§æ‰¿äº† <code>AFURLSessionManager</code> ï¼Œå†…éƒ¨åŸºæœ¬ä¸€è‡´ï¼Œæ·»åŠ äº† <code>AFHTTPRequestSerializer</code> å±æ€§ã€‚å¹¶é»˜è®¤æä¾›äº†ä¸€ä¸ª <code>AFHTTPRequestSerializer</code> ä½œä¸ºå…¶é»˜è®¤å€¼ã€‚åŒæ—¶å¯¹äº <code>requestSerializer</code> å±æ€§çš„å®šä¹‰ä¹Ÿæœ‰æ‰€å˜åŒ–ï¼Œä½†é»˜è®¤èµ‹å€¼è¿˜æ˜¯ <code>AFJSONResponseSerializer</code> ã€‚</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// In AFURLSessionManager</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="type">id</span> &lt;AFURLResponseSerialization&gt; responseSerializer;</span><br><span class="line"><span class="comment">// In AFHTTPSessionManager</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) AFHTTPResponseSerializer &lt;AFURLResponseSerialization&gt; * responseSerializer</span><br></pre></td></tr></table></figure>

<p>æ·»åŠ äº†ä¸€ä¸ª <code>baseURL</code> å±æ€§ï¼Œæ–¹ä¾¿åœ¨ä¹‹åçš„è¯·æ±‚ä¸­ï¼Œåªç”¨æä¾›å‰©ä¸‹çš„æ–‡ä»¶è·¯å¾„ã€‚</p>
<p>ä¸»è¦æä¾›äº†ä¸€äº›å¸¦æœ‰ HTTP method ï¼ˆGETã€POST ç­‰ï¼‰çš„ data task ç›¸å…³æ–¹æ³•ï¼Œå…¶å†…éƒ¨å®ç°åŸºæœ¬éƒ½æ˜¯ç›´æ¥è°ƒç”¨äº†ä¸‹é¢çš„è¿™ä¸ªç§æœ‰æ–¹æ³•ï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)dataTaskWithHTTPMethod:(<span class="built_in">NSString</span> *)method</span><br><span class="line">                                       URLString:(<span class="built_in">NSString</span> *)URLString</span><br><span class="line">                                      parameters:(<span class="keyword">nullable</span> <span class="type">id</span>)parameters</span><br><span class="line">                                         headers:(<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span> &lt;<span class="built_in">NSString</span> *, <span class="built_in">NSString</span> *&gt; *)headers</span><br><span class="line">                                  uploadProgress:(<span class="keyword">nullable</span> <span class="type">void</span> (^)(<span class="built_in">NSProgress</span> *uploadProgress)) uploadProgress</span><br><span class="line">                                downloadProgress:(<span class="keyword">nullable</span> <span class="type">void</span> (^)(<span class="built_in">NSProgress</span> *downloadProgress)) downloadProgress</span><br><span class="line">                                         success:(<span class="keyword">nullable</span> <span class="type">void</span> (^)(<span class="built_in">NSURLSessionDataTask</span> *task, <span class="type">id</span> _Nullable responseObject))success</span><br><span class="line">                                         failure:(<span class="keyword">nullable</span> <span class="type">void</span> (^)(<span class="built_in">NSURLSessionDataTask</span> * _Nullable task, <span class="built_in">NSError</span> *error))failure;</span><br></pre></td></tr></table></figure>

<p>è¯¥æ–¹æ³•ä¸­åˆ©ç”¨ <code>AFHTTPRequestSerializer</code> æ¥å°† <code>method</code> <code>URLString</code> å’Œ <code>paramters</code> åˆå¹¶æˆä¸€ä¸ª <code>NSMutableURLRequest</code> å¹¶éå†æ‰€æœ‰çš„ <code>headers</code> ä¸­çš„é”®å€¼å¯¹ã€‚æ¥ä½¿ç”¨ <code>setValue: forHTTPHeaderField:</code> æ–¹æ³•æ›´æ”¹ Header ä¸­çš„å€¼ï¼Œæœ€åè°ƒç”¨çˆ¶ç±»ä¸­åˆ›å»º data task çš„æ–¹æ³•ã€‚</p>
<h2 id="AFHTTPRequestSerializer"><a href="#AFHTTPRequestSerializer" class="headerlink" title="AFHTTPRequestSerializer"></a>AFHTTPRequestSerializer</h2><p><code>AFHTTPRequestSerializer</code> å®ç°äº†åè®® <code>AFURLRequestSerialization</code> ã€‚è¯¥åè®®æä¾›äº†ä»¥ä¸‹çš„æ–¹æ³•ï¼Œè€Œ <code>AFHTTPRequestSerializer</code> ä¹Ÿå°±æ˜¯é€šè¿‡è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ¥å°†ä¸€ä¸ª request å’Œ parameters è¿›è¡Œåºåˆ—åŒ–ï¼Œä»è€Œç”Ÿæˆä¸€ä¸ªæ–°çš„ requestï¼Œè¿™ä¸ªæ–¹æ³•çš„è¯¦ç»†å®ç°å°†åœ¨åç»­è®²è¿°ã€‚</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">NSURLRequest</span> *)requestBySerializingRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                                        withParameters:(<span class="keyword">nullable</span> <span class="type">id</span>)parameters</span><br><span class="line">                                                 error:(<span class="built_in">NSError</span> * _Nullable __autoreleasing *)error <span class="built_in">NS_SWIFT_NOTHROW</span>;</span><br></pre></td></tr></table></figure>

<p><code>AFHTTPRequestSerializer</code> çš„åˆå§‹åŒ–è¿‡ç¨‹ä¸»è¦å¹²äº† 3 ä»¶äº‹ï¼š</p>
<ol>
<li>é€šè¿‡ <code>[NSLocale preferredLanguages]</code> ä»è®¾ç½®ä»å–å‡ºæœ¬æœºåå¥½çš„è¯­è¨€é¡ºåºï¼Œå¹¶ä½¿ç”¨æ­¤ä¿¡æ¯è®¾ç½® HTTP header ä¸­çš„ <strong>Accept-Language</strong> ã€‚</li>
<li>é€šè¿‡ bundle æˆ– device çš„ä¿¡æ¯è®¾ç½® HTTP header ä¸­çš„ <strong>User-Agent</strong> ã€‚</li>
<li>ä½¿ç”¨ KVO å°†è‡ªèº«ä½œä¸ºç›‘å¬è€…ï¼Œç›‘å¬å†…éƒ¨ä¸€äº›å…¶ä»–å±æ€§çš„å˜åŠ¨ã€‚å¦‚ <code>allowsCellularAccess</code> <code>HTTPShouldHandleCookies</code> ç­‰ï¼Œè¿™äº›ä¹Ÿéƒ½æ˜¯ <code>NSURLRequest</code> çš„ä¸€äº›å±æ€§ã€‚å±æ€§ä¼šåœ¨å˜åŠ¨æ—¶ï¼Œè¢«åŠ å…¥å†…éƒ¨çš„ <code>mutableObservedChangedKeyPaths</code> å±æ€§ä¸­ï¼Œè¯¥å±æ€§æ˜¯ä¸€ä¸ª <code>NSMutableSet</code> ã€‚</li>
</ol>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œè¯¥ç±»è¿˜æä¾›äº†ä¸€äº›ç”¨äºè®¾ç½® HTTP header çš„æ–¹æ³•ï¼Œå¦‚ï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)setValue:(<span class="built_in">NSString</span> *)value</span><br><span class="line">forHTTPHeaderField:(<span class="built_in">NSString</span> *)field;</span><br></pre></td></tr></table></figure>

<p>è¢«è®¾ç½® value å’Œ field éƒ½ä¼šä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜æ”¾åœ¨å†…éƒ¨çš„ä¸€ä¸ª <code>NSMutableDictionary</code> ä¸­ï¼Œç›´åˆ°æœ€åè°ƒç”¨ä¸Šé¢çš„åºåˆ—åŒ–æ–¹æ³•æ—¶æ‰ä¼šè¢«é›†ä½“ä½¿ç”¨ï¼Œé€šè¿‡è°ƒç”¨ <code>setValue:forHTTPHeaderField:</code> æ–¹æ³•è®¾ç½®æœ€ç»ˆ request çš„ HTTP header Fieldã€‚</p>
<p>ä¸€ä¸ªç»†èŠ‚æ˜¯ï¼Œä¸ºäº†ä¿è¯åœ¨ set header æ—¶çš„çº¿ç¨‹å®‰å…¨ï¼Œåœ¨è®¾ç½®æ—¶å†…éƒ¨ä½¿ç”¨äº† <code>dispatch_barrier_sync</code> ã€‚</p>
<h3 id="é-multipart-request"><a href="#é-multipart-request" class="headerlink" title="é multipart request"></a>é multipart request</h3><p><code>AFHTTPRequestSerializer</code> å¦å¤–çš„æ ¸å¿ƒ API å¯ä»¥åˆ†ä¸ºç”Ÿæˆ multipart request éƒ¨åˆ†å’Œé multipart request ä¸¤ä¸ªéƒ¨åˆ†æ¥çœ‹ã€‚é¦–å…ˆä»‹ç»é multipart request éƒ¨åˆ†ã€‚å…¶æ¥å£å¦‚ä¸‹ï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">NSMutableURLRequest</span> *)requestWithMethod:(<span class="built_in">NSString</span> *)method</span><br><span class="line">                                          URLString:(<span class="built_in">NSString</span> *)URLString</span><br><span class="line">                                         parameters:(<span class="keyword">nullable</span> <span class="type">id</span>)parameters</span><br><span class="line">                                              error:(<span class="built_in">NSError</span> * _Nullable __autoreleasing *)error;</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨è¯¥æ–¹æ³•æ—¶ï¼Œå…¶å†…éƒ¨ä¸»è¦åšäº†ä¸‰ä»¶äº‹ï¼š</p>
<ol>
<li>é€šè¿‡ URLString ç”Ÿæˆä¸€ä¸ª URLRequestï¼Œå¹¶å°†è¯¥è¯·æ±‚çš„ method è®¾ç½®ä¸ºæŒ‡å®šçš„ methodã€‚</li>
<li>éå†æ›´æ”¹è¿‡çš„å±æ€§åˆ—è¡¨ <code>mutableObservedChangedKeyPaths</code> ï¼Œä½¿ç”¨ <code>setValue:forKey:</code> æ–¹æ³•å»æ”¹å˜ request ä¸­å¯¹åº”å±æ€§çš„å€¼ã€‚</li>
<li>è°ƒç”¨ä¸Šé¢çš„åºåˆ—åŒ–æ–¹æ³•ï¼Œä¼ å…¥ç”Ÿæˆçš„è¿™ä¸ª request ä»¥åŠå‚æ•°ä¸­çš„ parameters å’Œ errorã€‚</li>
</ol>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹åºåˆ—åŒ–æ–¹æ³•å†…éƒ¨è¿‡ç¨‹ã€‚å…¶æ–¹æ³•å†…éƒ¨å¤§æ¦‚æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li><code>mutableCopy</code> ä¼ å…¥çš„ requestï¼Œå¹¶å°† serializer å†…éƒ¨ä¹‹å‰è®¾ç½®çš„ headers é€šè¿‡ <code>setValue:forHTTPField:</code> è®¾ç½®åˆ° request ä¸Šã€‚</li>
<li>å¦‚æœä¼ å…¥çš„ parameters ä¸ä¸ºç©ºï¼Œé¦–å…ˆçœ‹å¤–éƒ¨æœ‰æ²¡æœ‰æŒ‡å®šä¸€ä¸ª block æ¥å¤„ç† parameterï¼ˆé€šè¿‡ä¸€ä¸ª property è®¾ç½®ï¼‰ï¼Œæœ‰å°±é€šè¿‡è¿™ä¸ª block å¤„ç† parametersï¼Œå¦‚æœæ²¡æœ‰å°±å°†å®ƒä»¬è½¬æ¢ä¸º <code>key=value</code> çš„å½¢å¼å¹¶ç”¨ <code>&amp;</code> ä¸²è”æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä½œä¸º queryã€‚</li>
<li>æœ€åå¦‚æœè¯·æ±‚æ–¹æ³•æ˜¯ GET, HEAD, DELETE ä¸­çš„ä¸€ç§ï¼Œå°±ç›´æ¥å§ query æ‹¼æ¥åœ¨ request çš„ URL ä¸Šã€‚å¦‚æœä¸æ˜¯è€Œä¸” request æ²¡æœ‰ <strong>Content-Type</strong> å°±å°†å…¶è®¾ç½®ä¸º <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/POST">application&#x2F;x-www-form-urlencoded</a>ï¼Œç„¶åæŠŠ query è½¬æ¢ä¸º <code>NSData</code> è®¾ç½®åˆ° HTTP çš„ body ä¸Šã€‚</li>
<li>è¿”å›ä¸Šé¢å¤„ç†å¥½çš„ requestã€‚</li>
</ol>
<h3 id="Multipart-request"><a href="#Multipart-request" class="headerlink" title="Multipart request"></a>Multipart request</h3><p>é¦–å…ˆæˆ‘ä»¬è¦æ˜ç™½ multipart request ç»“æ„æ˜¯ä»€ä¹ˆæ ·çš„ã€‚ä½¿ç”¨ Postman å‘é€ç½‘ç»œè¯·æ±‚å¯ä»¥æŒ‡å®š body æ ¼å¼ä¸º form-dataï¼ˆmethod ç±»å‹ä¸èƒ½æ˜¯ GET å’Œ HEADï¼‰ï¼Œè¡¨ç¤ºä»¥è¡¨å•å½¢å¼æäº¤ï¼Œè¡¨å•æ•°æ®å°†ä¼šè¢«å¤„ç†æˆä¸€æ¡è¯·æ±‚ï¼Œæ­¤æ—¶å‘é€çš„å°±æ˜¯ä¸€ä¸ª multipart requestã€‚åŒæ—¶å‘é€è¿™ç±»è¯·æ±‚æˆ‘ä»¬å¯ä»¥æŒ‡å®š value æ˜¯ä¸€ä¸ªæ–‡ä»¶ã€‚</p>
<p><img src="https://res.craft.do/user/full/ea081854-0d6c-dace-b07b-5007ad758cc9/doc/BAA570CA-8DD7-4D68-9E22-C44B50358FF0/A7762D1C-23C0-4C22-BDB5-1B57A4D45E02_2/dxyIZJfqN7r5cBrqTGtYxYWPNlu8HmnqvBvCB3LmOngz/Image.png" alt="Image.png"></p>
<p>æˆ‘ä»¬æ¥ä¸‹æ¥é€šè¿‡å®é™…å‘é€çš„ HTTP åŒ…æ¥çœ‹ä¸€ä¸‹ multipart request çš„å…·ä½“æ ¼å¼ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">POST /post HTTP/1.1</span><br><span class="line">User-Agent: PostmanRuntime/7.29.0</span><br><span class="line">Accept: */*</span><br><span class="line">Postman-Token: d3f08e2a-5e01-4f6a-9279-2689018f30eb</span><br><span class="line">Host: httpbin.org</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Type: multipart/form-data; boundary=--------------------------833910809558491007284810</span><br><span class="line">Content-Length: 1250051</span><br><span class="line"></span><br><span class="line">----------------------------833910809558491007284810</span><br><span class="line">Content-Disposition: form-data; name=&quot;Hello&quot;; filename=&quot;Hello.swift&quot;</span><br><span class="line">Content-Type: application/octet-stream</span><br><span class="line"></span><br><span class="line">print(&quot;hello world&quot;)</span><br><span class="line">----------------------------833910809558491007284810</span><br><span class="line">Content-Disposition: form-data; name=&quot;image&quot;; filename=&quot;Pid89915350.jpg&quot;</span><br><span class="line">Content-Type: image/jpeg</span><br><span class="line"></span><br><span class="line"># image raw data</span><br><span class="line">----------------------------833910809558491007284810</span><br><span class="line">Content-Disposition: form-data; name=&quot;key1&quot;</span><br><span class="line"></span><br><span class="line">value1</span><br><span class="line">----------------------------833910809558491007284810--</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºå…¶å‡ ä¸ªç‰¹ç‚¹ï¼š</p>
<ul>
<li><strong>Content-Type</strong> å¯¹åº”çš„å€¼æ˜¯ <strong>multipart&#x2F;form-data</strong> è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª multipart requestã€‚</li>
<li>Content-Type åé¢æŒ‡å®šäº†ä¸€ä¸ªåˆ†å‰²ç¬¦ boundaryã€‚åç»­åœ¨ body ä¸­ä¹Ÿæ˜¯é€šè¿‡è¿™ä¸ªåˆ†å‰²ç¬¦åˆ†å‰²ä¸åŒçš„é”®å€¼å¯¹ã€‚</li>
<li>body ä¸­é™¤äº†ç”¨åˆ†å‰²ç¬¦åˆ†å‰²é”®å€¼å¯¹ä¹‹å¤–ï¼Œæ¯ä¸ªé”®å€¼å¯¹éƒ½ä¼šæŒ‡å®š <strong>Content-Disposition</strong> å±æ€§ï¼Œå¦‚æœæ˜¯æ–‡ä»¶ï¼Œè¿˜ä¼šåœ¨åé¢å¸¦ä¸Š filenameã€‚</li>
<li>å¦‚æœæ˜¯æ–‡ä»¶ï¼Œè¿˜ä¼šæ ¹æ®æ–‡ä»¶ç±»å‹æŒ‡å®š <strong>Content-Type</strong> ã€‚</li>
</ul>
<p>äº†è§£å®Œäº† multiple request çš„åŸºæœ¬æ¦‚å¿µï¼Œä¸‹é¢æ¥çœ‹çœ‹ AFNetworking æ¡†æ¶æ€ä¹ˆå¤„ç†è¿™ç§è¯·æ±‚ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€äº›å†…éƒ¨åˆ›å»ºçš„ç±»ï¼ŒAFNetworking é€šè¿‡è¿™äº›ç±»æ¥å¤„ç† multiple request è¯·æ±‚ï¼Œè¿™äº›ç±»ä¼šåœ¨åé¢åˆ›å»º request çš„æµç¨‹ä¸­è¿›è¡Œæ›´è¯¦ç»†çš„ä»‹ç»ï¼š</p>
<p><img src="https://res.craft.do/user/full/ea081854-0d6c-dace-b07b-5007ad758cc9/doc/BAA570CA-8DD7-4D68-9E22-C44B50358FF0/B94B9153-DB9A-4272-AC7E-97E551F23EB8_2/raPlHT80coNtIOSDen7w3Z74hyjDcOz9v2P2mLC4MY0z/AFMultipartFormData.png" alt="AFMultipartFormData.png"></p>
<p>AFNetworking é€šè¿‡å¦‚ä¸‹æ–¹æ³•åˆ›å»ºä¸€ä¸ª multipart requestï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSMutableURLRequest</span> *)multipartFormRequestWithMethod:(<span class="built_in">NSString</span> *)method</span><br><span class="line">                                              URLString:(<span class="built_in">NSString</span> *)URLString</span><br><span class="line">                                             parameters:(<span class="built_in">NSDictionary</span> *)parameters</span><br><span class="line">                              constructingBodyWithBlock:(<span class="type">void</span> (^)(<span class="type">id</span> &lt;AFMultipartFormData&gt; formData))block</span><br><span class="line">                                                  error:(<span class="built_in">NSError</span> *__autoreleasing *)error;</span><br></pre></td></tr></table></figure>

<p>æ–¹æ³•å†…éƒ¨é¦–å…ˆé€šè¿‡ä¸Šé¢çš„ <code>requestWithMethod:URLString:parameters:error:</code> æ–¹æ³•åˆ›å»ºä¸€ä¸ªå¸¦ method çš„ requestï¼Œä½†ç”±äº multipart request ä¸­çš„ parameters çš„ key å¯èƒ½æ˜¯æ–‡ä»¶ï¼Œå› æ­¤è°ƒç”¨è¯¥æ–¹æ³•æ—¶ parameters å‚æ•°ä¼ å…¥çš„æ˜¯ <code>nil</code> ã€‚</p>
<p>éšåä½¿ç”¨è¯¥åˆ›å»ºçš„ request åˆå§‹åŒ–ä¸€ä¸ª <code>AFStreamingMultipartFormData</code> ï¼Œè¯¥ç±»åœ¨åˆå§‹åŒ–æ—¶ä¼šéšæœºç”Ÿæˆ multipart request éœ€è¦çš„åˆ†å‰²ç¬¦ï¼ˆboundaryï¼‰ã€‚åŒæ—¶å†…éƒ¨åˆå§‹åŒ–ä¸€ä¸ª <code>AFMultipartBodyStream</code> ä½œä¸ºå…¶å±æ€§ ï¼Œè¯¥ç±»ç»§æ‰¿äº† <code>NSInputStream</code> å¹¶å®ç°äº† <code>NSStreamDelegate</code> ä¸­çš„æ–¹æ³•ã€‚å†å¯¹æ•°æ®è¿›è¡Œå¤„ç†åå°†åœ¨æœ€åè¢«è®¾ç½®åˆ° request çš„ httpBodyStream ä¸Šã€‚</p>
<p>åˆ›å»ºç»“æŸåï¼Œå†…éƒ¨ä¼šéå† parametersï¼Œå¯¹é‚£äº›ä¸æ˜¯ <code>NSData</code> çš„ value è¿›è¡Œè½¬æ¢ï¼ˆå¯èƒ½æ˜¯æ™®é€šå­—ç¬¦ç±»å‹ï¼‰ï¼Œç»Ÿä¸€æˆ <code>NSData</code> ç±»å‹ï¼Œéšåè°ƒç”¨ <code>AFStreamMultipartFormData</code> çš„ <code>appendPartWithFormData:name:</code> æ–¹æ³•å°†å…¶æŒ¨ä¸ªåŠ å…¥åˆ° form data ä¸­ã€‚è¿™ä¸ªæ·»åŠ è¿‡ç¨‹åˆåˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š</p>
<ol>
<li>é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ª dictionaryï¼Œç„¶åè®¾ç½®äº† <strong>Content-Disposition</strong> å€¼ã€‚</li>
<li>éšååˆ›å»ºäº†ä¸€ä¸ª <code>AFHTTPBodyPart</code> å®ä¾‹ï¼Œæ¯ä¸€ä¸ª <code>AFHTTPBodyPart</code> çš„å®ä¾‹ï¼Œå…¶å®å°±æ˜¯ä»£è¡¨äº†ä¸Šé¢æˆ‘ä»¬çœ‹åˆ°äº† multipart request HTTP å¤´é‡Œé¢ä¸¤ä¸ªåˆ†å‰²çº¿ä¹‹é—´çš„ä¸€å—å†…å®¹ï¼ˆä¸€ä¸ªé”®å€¼å¯¹ï¼‰ã€‚åˆ›å»ºåå°†ä¸Šé¢è®¾ç½®è¿‡çš„ dictionary ä½œä¸ºäº† bodyPart çš„ headersï¼Œä¼ å…¥çš„ data ä½œä¸ºå…¶ bodyï¼ŒåŒæ—¶è®¾ç½®äº†åˆ†å‰²ç¬¦å’Œ content lengthã€‚</li>
<li>æœ€åå°†ç”Ÿæˆçš„è¿™ä¸ª body part åŠ åˆ°ä¸Šé¢ç”Ÿæˆçš„ body stream é‡Œé¢ã€‚è¿™ä¸ªåŠ å…¥é€»è¾‘å®é™…ä¸Šå°±æ˜¯å°†è¿™ä¸ªæ–°ç”Ÿæˆ body part æ”¾åˆ°äº†å†…éƒ¨çš„ä¸€ä¸ª array ä¸­ã€‚</li>
</ol>
<p>éšåä¼šè°ƒç”¨å‚æ•°ä¸­çš„ blockï¼Œå¹¶å°†åˆ›å»ºçš„ formData å®ä¾‹ä¼ å…¥ã€‚åœ¨ block ä¸­ï¼Œä½¿ç”¨è€…å¯ä»¥è°ƒç”¨ <code>AFMultipartFormData</code> åè®®ä¸­çš„ä¸€äº›å…¶ä»–æ–¹æ³•ï¼Œå°†æ•°æ®æ·»åŠ åˆ° multipart request çš„ body ä¸­ã€‚æ¯”å¦‚:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">BOOL</span>)appendPartWithFileURL:(<span class="built_in">NSURL</span> *)fileURL</span><br><span class="line">                         name:(<span class="built_in">NSString</span> *)name</span><br><span class="line">                        error:(<span class="built_in">NSError</span> * __autoreleasing *)error</span><br></pre></td></tr></table></figure>

<p>ä¼šé€šè¿‡åœ¨å†…éƒ¨è®¾ç½® <strong>Content-Disposition</strong> å’Œ <strong>Content-Type</strong> ï¼ŒåŒæ ·ä¹Ÿç”Ÿæˆä¸€ä¸ª <code>AFHTTPBodyPart</code> å®ä¾‹ï¼Œå¹¶è®¾ç½®å…¶ headersã€bodyï¼ˆè®¾ç½®ä¸ºè¿™é‡Œçš„ fileURLï¼‰ç­‰å±æ€§ï¼Œæœ€åæ·»åŠ åˆ° body stream é‡Œé¢ã€‚</p>
<p>multipart request æ–¹æ³•æœ€åä¼šè°ƒç”¨ form data çš„ <code>requestByFinalizingMultipartFormData</code> æ–¹æ³•ç”Ÿæˆä¸€ä¸ª request è¿”å›ã€‚è¯¥æ–¹æ³•å†…éƒ¨ç”Ÿæˆäº†ä¸€ä¸ª requestï¼Œè®¾ç½®äº†å…¶ <strong>Content-Type</strong> ä¸º <strong>multipart&#x2F;form-data; boundary&#x3D;â€¦</strong>ï¼ŒåŒæ—¶ <strong>Content-Length</strong> ä¸º body stream çš„å¤§å°<strong>ã€‚</strong>å¹¶è®¾ç½®äº†å…¶ http body stream ä¸ºä¸Šé¢çš„ <code>AFMultipartBodyStream</code> å®ä¾‹ã€‚å¦å¤–è¿˜æŒ‡å®šåªæœ‰ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ª body part åˆ†åˆ«éœ€è¦åˆå§‹åˆ†å‰²ç¬¦å’Œç»“æŸåˆ†å‰²ç¬¦ã€‚</p>
<p>ç”±äº <code>AFMultipartBodyStream</code> ç»§æ‰¿äº† <code>NSInputStream</code> ï¼Œå®é™…è¦å»çœ‹å‘é€æ—¶å¦‚ä½•å¤„ç†å†…éƒ¨çš„ headers å’Œ body è¿˜æ˜¯éœ€è¦å»çœ‹å®ƒå¦‚ä½•é‡å†™äº† <code>read:maxLength:</code> æ–¹æ³•ã€‚è¯¥æ–¹æ³•å†…éƒ¨å®ç°å°±æ˜¯éå†å†…éƒ¨çš„æ‰€æœ‰ <code>AFHTTPBodyPart</code> å®ä¾‹ç„¶åè°ƒç”¨æ¯ä¸€ä¸ªå®ä¾‹çš„ <code>read:maxLength:</code> æ–¹æ³•ã€‚</p>
<p>è¯¥æ–¹æ³•å†…éƒ¨é€šè¿‡ <code>AFHTTPBodyPart</code> ä¸­å®šä¹‰çš„å¦‚ä¸‹æšä¸¾ç±»ï¼Œåˆ†é˜¶æ®µå°†æ•°æ®åˆ†å¸ƒå†™è¿› buffer ä¸­ï¼Œæ¯æ¬¡å†™å®Œä¸€ä¸ªé˜¶æ®µå°±ä¼šå‰å¾€ä¸‹ä¸€ä¸ªé˜¶æ®µã€‚</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;</span><br><span class="line">    AFEncapsulationBoundaryPhase = <span class="number">1</span>, <span class="comment">// å†™åˆå§‹åˆ†å‰²ç¬¦æˆ–è€…ä¸­é—´åˆ†å‰²ç¬¦çš„é˜¶æ®µ</span></span><br><span class="line">    AFHeaderPhase                = <span class="number">2</span>, <span class="comment">// å†™ headers çš„é˜¶æ®µï¼ŒåŒ…æ‹¬ content-dispostion ç­‰</span></span><br><span class="line">    AFBodyPhase                  = <span class="number">3</span>, <span class="comment">// å†™ body çš„é˜¶æ®µ</span></span><br><span class="line">    AFFinalBoundaryPhase         = <span class="number">4</span>, <span class="comment">// å†™ç»“å°¾åˆ†å‰²ç¬¦çš„é˜¶æ®µï¼Œåªæœ‰æœ€åä¸€ä¸ª body part æœ‰è¿™ä¸ªé˜¶æ®µ</span></span><br><span class="line">&#125; AFHTTPBodyPartReadPhase;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ 1ã€2ã€4 é˜¶æ®µéƒ½æ˜¯å°†å­—ç¬¦ä¸²è½¬æ¢ä¸º <code>NSData</code> ç„¶åå†™å…¥ï¼Œ2 é˜¶æ®µå†™å…¥å‰ï¼Œä¼šè®²æ‰€æœ‰çš„ headers ä»¥ <code>key: value</code> çš„å½¢å¼æ‹¼æ¥èµ·æ¥ï¼Œå¹¶ä»¥æ¢è¡Œç¬¦ä¸²è”æˆä¸€ä¸ªæ•´çš„å­—ç¬¦ä¸²ã€‚</p>
<p>ç¬¬ 3 é˜¶æ®µåˆ™ä¼šæ ¹æ®å½“å‰ body çš„ç±»å‹ï¼ˆ<code>NSData</code> <code>NSURL</code> æˆ–è€… <code>NSInputStream</code>ï¼‰åˆå§‹åŒ–ä¸€ä¸ª <code>NSInputStream</code> ï¼Œå¹¶ä»ä¸­è¯»å–ã€‚</p>
<p>ä»¥ä¸Šå°±æ˜¯æ•´ä¸ª multipart request ç”Ÿæˆå’Œå¤„ç†çš„è¿‡ç¨‹ã€‚</p>
<p><code>AFHTTPRequestSerializer</code> çš„ä¸¤ä¸ªå­ç±» <code>AFJSONRequestSerializer</code> å’Œ <code>AFPropertyListRequestSerializer</code> å…¶çˆ¶ç±»çš„å¤„ç†ç±»ä¼¼ã€‚ä¸è¿‡åˆ†åˆ«å°† <strong>Content-Type</strong> è®¾ç½®ä¸ºäº† <strong>application&#x2F;json</strong> å’Œ <strong>application&#x2F;x-plist</strong> ã€‚æœ€åè¿˜æ˜¯å°†å¯¹åº”æ ¼å¼çš„æ•°æ®è½¬æ¢ä¸ºäº† <code>NSData</code> è®¾ç½®åˆ°äº† HTTP body ä¸Šã€‚</p>
<h2 id="AFHTTPResponseSerializer"><a href="#AFHTTPResponseSerializer" class="headerlink" title="AFHTTPResponseSerializer"></a>AFHTTPResponseSerializer</h2><p>å¯¹ response è¿›è¡Œæ ¼å¼åŒ–çš„ç±»ç›¸å¯¹è€Œè¨€æ¯”è¾ƒç®€å•ï¼Œå®é™…ä½¿ç”¨æ—¶ä¸»è¦ä½¿ç”¨ <code>AFHTTPResponseSerializer</code> çš„ç‰¹å®šæ ¼å¼çš„å­ç±»ï¼Œå¦‚ <code>AFJSONResponseSerializer</code> , <code>AFXMLParserResponseSerializer</code> ç­‰ã€‚</p>
<p>æ ¸å¿ƒä½œç”¨æ˜¯é€šè¿‡ä»¥ä¸‹æ–¹æ³•å°† response è§£ææˆå¯¹è±¡ã€‚</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">id</span>)responseObjectForResponse:(<span class="built_in">NSURLResponse</span> *)response</span><br><span class="line">                           data:(<span class="built_in">NSData</span> *)data</span><br><span class="line">                          error:(<span class="built_in">NSError</span> *__autoreleasing *)error;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸»è¦è¿‡ç¨‹é¦–å…ˆæ˜¯æ£€æŸ¥çŠ¶æ€ç çœ‹è¯·æ±‚æ˜¯å¦æˆåŠŸï¼Œç„¶åæ£€æŸ¥ä¸€äº› response çš„å‚æ•°æ˜¯å¦é½å…¨ï¼Œå¦‚ <strong>Content-Type</strong> ï¼Œéšåè¿˜ä¼šæ£€æŸ¥å…¶ä¸­çš„ <strong>Content-Type</strong> æ˜¯å¦æ˜¯å¯¹åº”çš„æ ¼å¼ï¼ˆå¦‚ä½¿ç”¨ <code>AFJSONResponseSerializer</code> è¦æ±‚å€¼ä¸º <code>@&quot;application/json&quot;, @&quot;text/json&quot;, @&quot;text/javascript&quot;</code> ä¸­çš„ä¸€ç§ï¼‰ã€‚æœ€åä½¿ç”¨å¯¹åº”çš„è§£æå™¨å°†æ•°æ®è§£æä¸ºå¯¹è±¡ã€‚</p>
</div></article></div></main><footer><div class="paginator"><a class="next" href="../../../03/28/%F0%9F%8D%B1%20iOS%20%E8%87%AA%E5%8A%A8%E5%B8%83%E5%B1%80%E5%92%8C%20Masonry%20%E6%A1%86%E6%9E%B6/">NEXT</a></div><div class="copyright"><p>Â© 2019 - 2022 <a href="http://example.com">Shanyu Li</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/claymcleod/hexo-theme-hermes" target="_blank">hexo-theme-hermes</a>. </p><p>Logo made by <a target="_blank" rel="noopener" href="https://www.flaticon.com/authors/freepik">Freepik</a> from <a target="_blank" rel="noopener" href="https://flaticon.com">www.flaticon.com</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>